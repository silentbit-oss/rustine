warning: the function has a cognitive complexity of (44/25)
