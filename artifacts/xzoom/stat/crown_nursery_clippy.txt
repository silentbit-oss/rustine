warning: the function has a cognitive complexity of (68/25)
